
.SUBCKT PIXEL_SENSOR VBN1 VRAMP VRESET ERASE EXPOSE READ
+ DATA_7 DATA_6 DATA_5 DATA_4 DATA_3 DATA_2 DATA_1 DATA_0 VDD VSS


XS1 VRESET VSTORE ERASE EXPOSE VDD VSS SENSOR

XC1 VCMP_OUT VSTORE VRAMP VDD VSS COMP


XM1 READ VCMP_OUT DATA_7 DATA_6 DATA_5 DATA_4 DATA_3 DATA_2 DATA_1 DATA_0 VDD VSS MEMORY

.ENDS

.SUBCKT MEMORY READ VCMP_OUT
+ DATA_7 DATA_6 DATA_5 DATA_4 DATA_3 DATA_2 DATA_1 DATA_0 VDD VSS

XM1 VCMP_OUT DATA_0 READ VSS MEMCELL
XM2 VCMP_OUT DATA_1 READ VSS MEMCELL
XM3 VCMP_OUT DATA_2 READ VSS MEMCELL
XM4 VCMP_OUT DATA_3 READ VSS MEMCELL
XM5 VCMP_OUT DATA_4 READ VSS MEMCELL
XM6 VCMP_OUT DATA_5 READ VSS MEMCELL
XM7 VCMP_OUT DATA_6 READ VSS MEMCELL
XM8 VCMP_OUT DATA_7 READ VSS MEMCELL

.ENDS

.SUBCKT MEMCELL CMP DATA READ VSS
M1 VG CMP DATA VSS nmos  w=0.2u  l=0.13u
M2 DATA READ DMEM VSS nmos  w=0.4u  l=0.13u
M3 DMEM VG VSS VSS nmos  w=1u  l=0.13u
C1 VG VSS 1p
.ENDS

.SUBCKT SERIESCURR DRAIN GATE SOURCE BULK w=0.5u l=0.5u
MS1 DRAIN GATE NODE1 BULK nmos W=w L=l
MS2 NODE1  GATE NODE2 BULK nmos W=w L=l
MS3 NODE2  GATE NODE3 BULK nmos W=w L=l
MS4 NODE3  GATE NODE4 BULK nmos W=w L=l
MS5 NODE4  GATE NODE5 BULK nmos W=w L=l
MS6 NODE5  GATE SOURCE BULK nmos W=w L=l
.ends

.SUBCKT SENSOR VRESET VSTORE ERASE EXPOSE VDD VSS

* Capacitor to model gate-source capacitance
C1 VSTORE VSS 100f
*MC65 VSS VSTORE VSS VSS nmos w=0.5u l=0.5u m 20
*Rleak VSTORE VSS 100T

* Switch to reset voltage on capacitor
*BR1 VRESET VSTORE I=V(ERASE)*V(VRESET,VSTORE)/1k
.model NMOS NMOS (LEVEL=14)


M99 VRESET ERASE VSTORE VSTORE nmos w=0.5u l=0.1u 
* Switch to expose pixel
*BR2 VPG VSTORE I=V(EXPOSE)*V(VSTORE,VPG)/1k

M100 VPG EXPOSE VSTORE VSTORE nmos w=0.5u l=0.1u 

*X23 VPG EXPOSE VSTORE VSTORE SERIESCURR
* Model photocurrent
Rphoto VPG VSS 1G
.ENDS



.SUBCKT SERIESCURR2 DRAIN GATE SOURCE BULK w=0.5u l=0.5u
MP1 DRAIN GATE NODE1 BULK pmos W=w L=l
MP2 NODE5  GATE SOURCE BULK pmos W=w L=l
.ends


.SUBCKT COMP VCMP_OUT VSTORE VRAMP VDD VSS

* Model comparator
*BC1 VCMP_OUT VSS V = ((atan(100000*(V(VSTORE) - V(VRAMP)))) + 1.58)/3.14*1.5

*\\\diff pair
MP1 VP VP VDD VDD pmos w=0.5u l=0.5u 
MP2 VO VP VDD VDD pmos w=0.5u l=0.5u 
*XMP1 VP VP VDD VDD SERIESCURR2
*XMP2 VO VP VDD VDD SERIESCURR2

MN1 VO VRAMP VS VS nmos w=0.5u l=0.15u
MN2 VP VSTORE VS VS nmos w=0.5u l=0.15u
*bias current mirror
I3 0 VBN1 dc 1u

XM1 VBN1 VBN1 VSS VSS SERIESCURR
XM2 VS VBN1 VSS VSS SERIESCURR
*MB1 VBN1 VBN1 VSS VSS nmos w=0.5u l=0.15u
*MB2 VS VBN1 VSS VSS nmos w=0.5u l=0.15u 

* Buffer
MP3 VO2 VO VDD VDD pmos w=0.5u l=0.15u 
MN3 VO2 VBN1 VSS VSS nmos w=0.5u l=0.5u

*INVERTER
MIP1 VCMP_OUT VO2 VDD VDD pmos w=0.5u l=0.5u
MIN2 VCMP_OUT VO2 VSS VSS nmos w=0.5u l=0.15u





.ENDS